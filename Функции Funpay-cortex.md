### 1. Старый режим получения сообщений (`oldMsgGetMode`)

Эта функция кардинально меняет способ, которым бот "узнает" о новых сообщениях.

#### Что это делает для пользователя?

*   **Включено (Новый режим, по умолчанию):** Бот видит всю историю чата, включая изображения и системные сообщения. Он точно знает, кто автор сообщения. Однако, после того как бот "прочитает" чат, он перестает быть подсвеченным оранжевым цветом на FunPay, так как с точки зрения сайта вы его просмотрели.
*   **Выключено (Старый режим):** Бот видит только **текст самого последнего сообщения** и не видит изображений. Он не "заходит" в чат, поэтому чат остается непрочитанным (оранжевым) на FunPay. Это позволяет вам видеть, какие диалоги требуют вашего личного внимания. Однако, если собеседник отправит несколько сообщений подряд, бот увидит только последнее из них.

#### Техническая реализация

Ключевая логика находится в файле `FunPayAPI/updater/runner.py`.

1.  **Настройка:** В файле `cortex.py` свойство `old_mode_enabled` считывает значение `oldMsgGetMode` из вашего `_main.cfg`. [cortex.py]
2.  **Инициализация `Runner`:** При запуске `Cortex` создает объект `Runner` и передает ему значение `self.old_mode_enabled` в параметр `disable_message_requests`. [cortex.py]
3.  **Логика в `Runner`:**
    *   Внутри `Runner.__init__` это значение сохраняется в `self.make_msg_requests`. Если "старый режим" **включен**, то `make_msg_requests` будет `False`. [FunPayCortex-main/FunPayAPI/updater/runner.py]
    *   Основной цикл обработки событий в `runner.py` в методе `parse_chat_updates` проверяет этот флаг:
        ```python
        # FunPayAPI/updater/runner.py

        if not self.make_msg_requests:
            events.extend(lcmc_events)
            return events
        ```
    *   Если `make_msg_requests` равен `False` (старый режим включен), то **не выполняется** дальнейший код, который вызывает `generate_new_message_events()`. [FunPayCortex-main/FunPayAPI/updater/runner.py]
    *   Функция `generate_new_message_events()` как раз и отвечает за отправку дополнительного запроса к FunPay (`account.get_chats_histories()`), чтобы получить полную историю сообщений из чата. [FunPayCortex-main/FunPayAPI/updater/runner.py]

Таким образом, "старый режим" — это, по сути, отключение механизма дополнительного запроса истории чата. Бот просто реагирует на самое базовое уведомление от FunPay "в чате X появилось новое сообщение с текстом Y", не углубляясь в детали.

| Плюсы старого режима | Минусы старого режима |
| :--- | :--- |
| ✅ Чаты остаются непрочитанными | ❌ Бот видит только последнее сообщение |
| ✅ Меньше запросов к FunPay | ❌ Не видит изображения |
| ✅ Быстрее реакция | ❌ Может ошибаться в определении автора |

---

### 2. Оставлять непрочитанным при отправке (`keepSentMessagesUnread`)

Эта функция влияет исключительно на то, что происходит **после отправки сообщения ботом**.

#### Что это делает для пользователя?

*   **Включено:** Когда бот отправляет сообщение (например, автоответ или товар), чат на FunPay **остается непрочитанным** (оранжевым). Это очень удобно, так как вы видите, что в этом диалоге была активность, и можете зайти проверить, все ли в порядке.
*   **Выключено (по умолчанию):** Когда бот отправляет сообщение, чат становится прочитанным, как если бы вы сами ответили через сайт.

#### Техническая реализация

Ключевая логика находится в файле `FunPayAPI/account.py` в методе `send_message`.

1.  **Настройка:** В файле `cortex.py` свойство `keep_sent_messages_unread` считывает значение из `_main.cfg`. [cortex.py]
2.  **Передача параметра:** `Cortex.send_message` передает это значение в `account.send_message` как параметр `leave_as_unread`. [cortex.py]
3.  **Логика в `Account.send_message`:**
    *   Этот метод формирует полезную нагрузку (`payload`) для отправки на сервер FunPay (`https://funpay.com/runner/`).
    *   Ключевой момент — формирование ключа `objects` в этом `payload`. Этот ключ говорит серверу FunPay, информацию о каких чатах нужно вернуть после выполнения действия.
    *   В коде есть проверка:
        ```python
        # FunPayAPI/account.py

        payload = {
            "objects": "" if leave_as_unread else json.dumps(objects),
            "request": json.dumps(request),
            "csrf_token": self.csrf_token
        }
        ```
    *   Если `leave_as_unread` равен `True`, то в `objects` передается **пустая строка**. Это говорит FunPay: "Отправь сообщение, но не присылай мне в ответ обновленное состояние чата".
    *   Именно запрос на обновление состояния чата и помечает его как "прочитанный". Не запрашивая его, бот оставляет чат "нетронутым".
    *   Так как бот не получает в ответ информацию об отправленном сообщении (его ID, точное время), он создает "фейковый" объект сообщения для возврата, чтобы остальная логика работала корректно. [FunPayCortex-main/FunPayAPI/account.py]

| Плюсы режима "Оставлять непрочитанным" | Минусы режима "Оставлять непрочитанным" |
| :--- | :--- |
| ✅ Вы всегда видите, в какие чаты отвечал бот | ❌ Бот не получает от FunPay подтверждения, что сообщение доставлено (хотя и узнает об ошибках) |
| ✅ Удобно для ручного контроля | ❌ Возвращаемый объект сообщения является "фейковым", без реального ID от FunPay |
